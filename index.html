<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="HandheldFriendly" content="true" />
  <title></title>
  
  <!--  Google Maps APi  -->
  <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBuHaXBlqtCm9YMJ6QFor8vswop84mf-7o&sensor=false&amp;libraries=places"></script>
  
  <!-- Stylesheets -->
  <link rel="stylesheet" href="https://d10ajoocuyu32n.cloudfront.net/mobile/1.3.1/jquery.mobile-1.3.1.min.css">
  <link rel="stylesheet" href="css/jqm_datebox_style.css">
  
  <!-- Extra Codiqa features -->
  <link rel="stylesheet" href="css/codiqa.ext.css">
  
  <!-- jQuery & Addons -->
  <script src="https://d10ajoocuyu32n.cloudfront.net/jquery-1.9.1.min.js"></script>
  <script src="https://d10ajoocuyu32n.cloudfront.net/mobile/1.3.1/jquery.mobile-1.3.1.min.js"></script>
  <script src="js/jqm_datebox.js"></script>
  <script src="js/flipbox.js"></script>
  <script type="text/javascript" src="js/jqm.maps.js"></script>
  <script type="text/javascript" src="js/jqm.maps.extensions.js"></script>
  <script src="js/jquery.geocomplete.js"></script>
  
  
  <!-- Extra Codiqa features -->
  <script src="https://d10ajoocuyu32n.cloudfront.net/codiqa.ext.js"></script>
</head>
<body>
<!-- Home -->
<div data-role="page" id="page1">
    <div data-theme="a" data-role="header">
        <span class="ui-title">
        	Park 'N Go
        </span>
        <a id="add" data-role="button" href="#page2" data-icon="plus" data-iconpos="notext" class="ui-btn-left add">
        </a>
        <a id="options" data-role="button" href="#page4" data-icon="gear" data-iconpos="notext" class="ui-btn-right search">
        </a>
    </div>
    <div data-role="content" class="map-page">
    	<input id="lat" type="hidden" value="">
    	<input id="long" type="hidden" value="">
    	<form class="search_details">
	    	<input name="lat" type="hidden" value="">
	    	<input name="lng" type="hidden" value="">
    	</form>
    	<form>
			<input type="search" class="search" name="search" id="search" value="" placeholder="Search for a city">
    	</form>
		<div id="map_canvas"></div>
    </div>
    <div class="footer" data-theme="a">
    	<a href="#page4">The Developers</a>
    </div>
</div>

<!-- Add Spot Page -->
<div data-role="page" id="page2">
	<div data-theme="a" data-role="header">
        <h3>Add A Spot</h3>
        <a id="map" data-role="button" href="#page1" data-icon="home" data-iconpos="notext" class="ui-btn-left map">
        </a>
        <a id="options" data-role="button" href="#page4" data-icon="gear" data-iconpos="notext" class="ui-btn-right options">
        </a>
    </div>
    <div data-role="content">
	    <div data-role="fieldcontain" class="first">
    		<div class="cur_loc">
    			<label for="street" class="ui-input-text">
	                *Current Location:
	            </label>
            	<select name="cur_loc_slider" id="cur_loc_slider" data-role="slider">
				    <option value="N">No</option>
				    <option value="Y" selected>Yes</option>
				</select>
				<div class="loc_input">
					<div class="ui-grid-b">
		        		<div class="ui-block-c">
							<input name="street" id="street_add" placeholder="Approximate Address" value="" type="text">
		        		</div>
		        		<div class="ui-block-d">
				            <input name="city" id="city_add" placeholder="City" value="" type="text">
		        		</div>
		        	</div>
	        	</div>
    		</div>
        </div>
		<form id="form_add">
			<input name="add_lat" type="hidden" value="">
			<input name="add_long" type="hidden" value="">
			<input name="add_address" class="add_address" type="hidden" value="">
	        <div data-role="fieldcontain">
	            <label for="cost_add">
	                Rate:
	            </label>
	            <input type="number" name="cost_add" id="cost_add" pattern="[0-9]+([\.|,][0-9]+)?" step="0.01" id="number-pattern" value="" placeholder="(optional)" class="ui-input-text ui-body-c ui-corner-all">
	        </div>
	        <div data-role="fieldcontain">
	        	<label for="notes">
	        		Notes:
	        	</label>
	        	<textarea name="notes" class="notes" rows="8"></textarea>
	        </div>
	        <button name="submit" data-theme="a" class="ui-btn-hidden" aria-disabled="true">Submit</button>
    	</form>
    </div>
</div>

<!-- Search Page -->
<!--
<div data-role="page" id="page3" name="add">
	<div data-theme="a" data-role="header">
        <h3>Options</h3>
        <a id="map" data-role="button" href="#page1" data-icon="home" data-iconpos="notext" class="ui-btn-left map">
        </a>
        <a id="options" data-role="button" href="#page2" data-icon="plus" data-iconpos="notext" class="ui-btn-right options">
        </a>
    </div>
    <div data-role="content">
    	<form>
    		<div data-role="fieldcontain">
				<label for="distance">
					Range (km):
				</label>
				<input type="range" name="distance" id="distance" value="10" min="0" max="100" step="5" data-highlight="true" />
    		</div>
    		<div data-role="fieldcontain">
				<label for="cost_search">
					Rate:
				</label>
				<input type="number" name="cost_search" id="cost_search" pattern="[0-9]*" id="number-pattern" value="" placeholder="(optional)" class="ui-input-text ui-body-c ui-corner-all">
    		</div>
    		<div data-role="fieldcontain">
	        	<div class="ui-grid-a">
	        		<div class="ui-block-a">
			            <label for="t_start_pref">
			                Start Time:
			            </label>
			            <input type="time" name="t_start_pref" id="t_start_pref">
	        		</div>
	        		<div class="ui-block-b">
			            <label for="t_end_pref">
			                End Time:
			            </label>
			            <input type="time" name="t_end_pref" id="t_end_pref">
	        		</div>
	        	</div>
	        </div>
	        <button type="submit" value="submit" data-theme="a" class="ui-btn-hidden" aria-disabled="true">Submit</button>
    	</form>
    </div>
</div>
-->

<!-- About Us Page -->
<div data-role="page" id="page4" name="dev">
	<div data-roll="content">
		<div data-theme="a" data-role="header">
	        <h3>Developers</h3>
	        <a id="map" data-role="button" href="#page1" data-icon="home" data-iconpos="notext" class="ui-btn-left map">
	        </a>
	    </div>
		<div data-role="fieldcontain" class="first">
			<div class="name">
				<h2>Daniel Young</h2>
			</div>
			<div class="desc-wrap">
				<div class="picture">
					<img src="img/daniel.png">
				</div>
				<div class="desc">
					<h4>2A Computing and Financial Management</h4>
					Front/back end design and implementation.
				</div>
			</div>
		</div>
		<div data-roll="fieldcontain">
			<div class="name">
				<h2>Kamaljot Dhaliwal</h2>
			</div>
			<div class="desc-wrap">
				<div class="picture">
					<img src="img/kam.png">
				</div>
				<div class="desc">
					<h4>2A Computing and Financial Management</h4>
					Database design and data capture.
				</div>
			</div>
		</div>
	</div>
</div>

<script>

$(document).ready(function(){
	/* Geolocation and Map init */
	var geocoder = new google.maps.Geocoder();
	$('#map_canvas').gmap({ 'center': new google.maps.LatLng(42.345573,-71.098326), "zoom": 3});
	$('#map_canvas').gmap().bind('init', function(evt, map) {
		$('#map_canvas').gmap('getCurrentPosition', function(position, status) {
			if ( status === 'OK' ) {
				$('#map_canvas').gmap('option','center',new google.maps.LatLng(position.coords.latitude, position.coords.longitude));
				$('input[name="add_lat"]').val(position.coords.latitude);
				$('input[name="add_long"]').val(position.coords.longitude);
				$('#map_canvas').gmap('option','zoom',14);
				$('#map_canvas').gmap('addMarker', {
					'position': new google.maps.LatLng(position.coords.latitude, position.coords.longitude),
					'icon': '/img/blue-pin.png'
				});
			}
		});   
	});
	
	function codeAddress() {
    var address = $('#street_add').val();
    var city = $('#city_add').val();
    geocoder.geocode( { 'address': address, 'componentRestrictions': {'locality': city}}, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
	    $('input[name="add_address"]', '#form_add').val(results[0].formatted_address);
	    $('input[name="add_lat"]', '#form_add').val(results[0].geometry.location.ob);
	    $('input[name="add_long"]', '#form_add').val(results[0].geometry.location.pb);
      } else {
        alert("Geocode was not successful for the following reason: " + status);
      }
    });
  }
  
  function codeLatLng() {
	var lat = $('input[name="add_lat"]').val();
	var lng = $('input[name="add_long"]').val();
	var latlng = new google.maps.LatLng(lat, lng);
	geocoder.geocode({'latLng': latlng}, function(results, status) {
	  if (status == google.maps.GeocoderStatus.OK) {
	    if (results[0]) {
	    	$('.add_address').val(results[0].formatted_address);
	    }
	  } else {
	    alert("Geocoder failed due to: " + status);
	  }
	});
}
	
	$("#search").geocomplete({
		details: ".search_details"
	}).bind("geocode:result", function(event, result){
		$('#map_canvas').gmap('option','center',new google.maps.LatLng($('.search_details input[name="lat"]').val(), $('.search_details input[name="lng"]').val()));
		$('#map_canvas').gmap('option','zoom',11);
	});

	/* Ajax call to get pins from database */
	
	setTimeout(function() {
		$.ajax({
			type: "GET",
			url: "scripts/get_spots.php",
			dataType: "json"
		}).done(function(dataJSON){
			var pinData = dataJSON.Pins;
			for(var i=0; i<pinData.length; i++){
				(function(){
				var content = "<div class='marker_info'><b>Address:</b> " + pinData[i].Address +
							  "<br><b>Type:</b> " + pinData[i].Type + 
							  "<br><b>Capacity:</b> " + pinData[i].Capacity +
							  "<br><b>Rate per half hour:</b> $ " + pinData[i].Rate30 +
							  "<br><b>Rate per day:</b> $ " + pinData[i].RateDay + 
							  "<br><b>Payment Methods</b>: " + pinData[i].Methods +
							  /* "<br><a href='https://maps.google.com/maps?saddr=" + $('#form_add input[name="add_lat').val() +"," + $('#form_add input[name="add_long').val() + "&daddr="+ pinData[i].Lat +"," + pinData[i].Long + "' target='_blank'>Get Directions</a>" + */
							  "</div>";
				$('#map_canvas').gmap('addMarker', {
					'position': new google.maps.LatLng(pinData[i].Lat, pinData[i].Long),
					'bounds': false
				}).click(function(){
					$('#map_canvas').gmap('openInfoWindow', {'content': content, 'maxWidth': '250'}, this);
				});
				})();
			}
		});
	}, 300);
	
	/* ajax call to get user added markers */
	setTimeout(function() {
		$.ajax({
			type: "GET",
			url: "scripts/get_user_spots.php",
			dataType: "json"
		}).done(function(dataJSON){
			var pinData2 = dataJSON.Pins;
			for(var i=0; i<pinData2.length; i++){
				(function(){
				var content = "<div class='marker_info'><b>Address:</b> " + pinData2[i].Address +
							  "<br><b>Type:</b> " + "Street" +
							  "<br><b>Rate:</b> $ " + pinData2[i].Cost +
							  "<br><b>Notes:</b> " + pinData2[i].notes +
							  /* "<br><a href='https://maps.google.com/maps?saddr=" + $('#form_add input[name="add_lat').val() +"," + $('#form_add input[name="add_long').val() + "&daddr="+ pinData2[i].Lat +"," + pinData2[i].Long + "' target='_blank'>Get Directions</a>" + */
							  "</div>";
				$('#map_canvas').gmap('addMarker', {
					'position': new google.maps.LatLng(pinData2[i].Lat, pinData2[i].Long),
					'bounds': false
				}).click(function(){
					$('#map_canvas').gmap('openInfoWindow', {'content': content, 'maxWidth': '250'}, this);
				});
				})();
			}
		});
	}, 400);
	
	/* Ajax call for user to add marker */
	$('button[name="submit"]').click(function(){
		if($('#cur_loc_slider option:selected').val() === 'Y'){
			codeLatLng();
		} else if ($('#cur_loc_slider option:selected').val() === 'N'){
			codeAddress();
		}
			setTimeout(function(){
				var dataStringAdd = "address=" + $('.add_address').val();
				dataStringAdd += "&lat=" + $('input[name="add_lat"]', '#form_add').val();
				dataStringAdd += "&lng=" + $('input[name="add_long"]', '#form_add').val();
				dataStringAdd += "&cost=" + $('input[name="cost_add"]', '#form_add').val();
				dataStringAdd += "&notes=" + $('.notes').val();
				$.ajax({
					type   : "POST",
					data   : dataStringAdd,
					url    : "scripts/add_spot.php"
				}).done(function(data) {
					if (data === "SUCCESS") {
						alert("Parking spot added.");
						window.location.href = "http://dev.kalindar.com";
					} else {
						alert("Error occured. Please try again");
						/* location.reload(); */
					}
				});
			return false;
		}, 1000);
	});
	
	
	$('#cur_loc_slider').change(function(){
		if ($('#cur_loc_slider option:selected').val() === 'N') {
			$('.loc_input').slideToggle();
		}
		if ($('.loc_input:visible') && $('#cur_loc_slider option:selected').val() === 'Y') {
			$('.loc_input').slideToggle();
		}
	});
});
</script>

</body>
</html>
